# Release v1.1.0 - Azure SQL DBA Agent & Diagnostic Validation Protocol

**Release Date:** December 29, 2025  
**Type:** Minor Release (Feature Addition + Critical Improvements)

---

## ğŸ¯ Highlights

Esta release introduce el **Azure SQL DBA Agent** completo con **Diagnostic Validation Protocol**, una metodologÃ­a rigurosa que previene errores de diagnÃ³stico basada en aprendizajes de incidentes reales. AdemÃ¡s, reorganiza completamente la estructura de scripts para mejor mantenibilidad.

### ğŸŒŸ Nuevas CaracterÃ­sticas Principales

1. **ğŸ”§ Azure SQL DBA Agent con ValidaciÃ³n DiagnÃ³stica**
   - Agente especializado con metodologÃ­a evidence-first
   - **Diagnostic Validation Protocol** (5 checkpoints obligatorios)
   - Troubleshooting avanzado de performance, bloqueos y crecimiento
   - Herramientas automatizadas con Azure AD authentication
   - Playbooks completos para escenarios comunes
   - **Lecciones aprendidas de incidentes reales documentadas**

2. **ğŸ“¦ Scripts de ValidaciÃ³n DiagnÃ³stica (NUEVO)**
   - `pre-diagnosis-zombie-validation.sh` - Checklist 5 pasos obligatorio
   - `post-diagnosis-validation.sh` - Auto-validaciÃ³n post-diagnÃ³stico
   - Previene falsos positivos en diagnÃ³sticos crÃ­ticos
   - Basado en caso real 2025-12 (zombie transactions false positive)

3. **ğŸ“¦ Scripts Organizados por Agente**
   - Nueva estructura: `scripts/common/`, `scripts/agents/architect/`, `scripts/agents/sql-dba/`
   - 87+ referencias actualizadas automÃ¡ticamente
   - Historia de Git preservada con `git mv`

4. **ğŸ” Herramientas SQL Avanzadas**
   - Scripts Python y Bash para ejecutar queries
   - Analizador de performance automatizado
   - DetecciÃ³n de transacciones zombie (ADR/PVS-aware)
   - Soporte completo para SQL auth y Azure AD auth

---

## ğŸ“‹ Changelog Detallado

### âœ¨ Features

#### Diagnostic Validation Protocol (ğŸ†• Post v1.1.0)
- **NEW**: `docs/reference/diagnostic-checklists.md` - Protocolos completos para 5 tipos de diagnÃ³stico
  - Zombie transactions checklist (con lecciones del caso 2025-12)
  - Blocking & deadlocks checklist
  - Storage growth checklist
  - Performance degradation checklist
  - Post-diagnosis validation checklist
- **NEW**: Pre-diagnosis validation script con 5 checkpoints automÃ¡ticos
- **NEW**: Post-diagnosis validation script con auto-validaciÃ³n
- **IMPROVED**: Azure_SQL_DBA agent con secciÃ³n "Lecciones Aprendidas de Incidentes Reales"
- **IMPROVED**: Playbook 3 integra pre-diagnosis validation obligatoria

**Caso de Estudio 2025-12: Falso Positivo "Zombie Transactions"**
- âŒ Error: Diagnosticar transacciones de 47 dÃ­as como "zombies" sin verificar contexto
- âœ… CorrecciÃ³n: Microsoft identificÃ³ que eran transacciones internas post-restart
- ğŸ“ Aprendizaje: `session_id=NULL` siempre es transacciÃ³n de sistema (NO usuario)
- ğŸ›¡ï¸ PrevenciÃ³n: Checklist obligatorio verifica uptime, correlaciÃ³n temporal, session ownership

#### Azure SQL DBA Agent
- **NEW**: Agente Azure_SQL_DBA con 1000+ lÃ­neas de documentaciÃ³n
- **NEW**: MetodologÃ­a evidence-first con 6 playbooks completos
- **NEW**: Sistema de aprobaciÃ³n para operaciones de escritura
- **NEW**: Checklist ADR/PVS para troubleshooting storage
- **NEW**: Scripts de diagnÃ³stico interactivos para SSMS
- **NEW**: Templates de email para Microsoft Support

#### SQL Tools & Automation
- **NEW**: `sql-query.py` - Ejecutor Python con Azure AD + SQL auth
- **NEW**: `sql-analyzer.sh` - 8 anÃ¡lisis de performance automatizados
- **NEW**: `sql-connect.sh` - Wrapper bash con variables de entorno
- **NEW**: `detect-zombie-transactions.sh` - DetecciÃ³n automatizada
- **NEW**: `zombie-diagnosis-interactive.sql` - Script para SSMS con 5 pasos

#### Documentation
- **NEW**: `azure-sql-connection-guide.md` - GuÃ­a completa de conexiÃ³n (327 lÃ­neas)
- **NEW**: `zombie-transactions-quickstart.md` - Quick reference para DBAs
- **NEW**: `sql-tools-guide.md` - Referencia de herramientas SQL
- **NEW**: `sql-solution-comparison.md` - AnÃ¡lisis de seguridad (400+ lÃ­neas)
- **NEW**: Templates para Microsoft Support (email-brief.txt)
- **NEW**: AnÃ¡lisis de patrones de uso para ventanas de mantenimiento

### ğŸ”§ Improvements

#### Infrastructure
- **IMPROVED**: ReorganizaciÃ³n completa de `scripts/` por agente
- **IMPROVED**: Bicep module `sql-database.bicep` con security baseline
- **IMPROVED**: WSL quick setup script con Miniconda y Azure CLI

#### Agente Capabilities
- **IMPROVED**: Azure Architect Agent con SQL tools integrados
- **IMPROVED**: Permisos de ejecuciÃ³n SQL documentados (READ-ONLY vs WRITE)
- **IMPROVED**: Workflow de aprobaciÃ³n para operaciones crÃ­ticas

### ğŸ› Bug Fixes

- **FIX**: SQL Server Bicep module corregido
- **FIX**: Workflows de calidad deshabilitados (ejecuciÃ³n manual)
- **FIX**: Backup files removidos del repositorio

### ğŸ” Security

- **SECURITY**: Todos los ejemplos usan credenciales anonymizadas
- **SECURITY**: Soporte Azure AD authentication preferido
- **SECURITY**: GuÃ­as de Key Vault para credenciales en producciÃ³n
- **SECURITY**: Private endpoints en mÃ³dulos Bicep
- **SECURITY**: Repository sanitizado (sin datos reales en commits)

### ğŸ“š Documentation

- **NEW**: `docs/reference/diagnostic-checklists.md` - Protocolos de validaciÃ³n diagnÃ³stica
- **IMPROVED**: Azure_SQL_DBA agent con lecciones de incidentes reales (caso 2025-12)
- **IMPROVED**: README actualizado con enlaces a checklists

---

## ğŸ“Š Statistics

- **Commits desde v1.0.0**: 19 (incluye mejoras post-release)
- **Archivos aÃ±adidos**: 15 (incluye scripts de validaciÃ³n)
- **Archivos modificados**: 26+
- **LÃ­neas de cÃ³digo aÃ±adidas**: 6,000+
- **DocumentaciÃ³n**: 3,400+ lÃ­neas (incluye diagnostic-checklists.md)
- **Scripts**: 9 nuevos scripts SQL/Bash/Python

---

## ğŸ—‚ï¸ Nueva Estructura de Scripts

```
scripts/
â”œâ”€â”€ common/              # Scripts compartidos
â”‚   â”œâ”€â”€ azure-config.sh
â”‚   â”œâ”€â”€ azure-login.sh
â”‚   â””â”€â”€ azure-utils.sh
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ architect/       # Azure Architect Agent
â”‚   â”‚   â”œâ”€â”€ bicep-deploy.sh
â”‚   â”‚   â””â”€â”€ bicep-utils.sh
â”‚   â””â”€â”€ sql-dba/        # Azure SQL DBA Agent
â”‚       â”œâ”€â”€ detect-zombie-transactions.sh
â”‚       â”œâ”€â”€ pre-diagnosis-zombie-validation.sh  # ğŸ†• ValidaciÃ³n 5 pasos
â”‚       â”œâ”€â”€ post-diagnosis-validation.sh        # ğŸ†• Auto-validaciÃ³n
â”‚       â”œâ”€â”€ sql-analyzer.sh
â”‚       â”œâ”€â”€ sql-connect.sh
â”‚       â”œâ”€â”€ sql-query.py
â”‚       â””â”€â”€ sql-query.sh
â””â”€â”€ setup/              # Setup & maintenance
    â”œâ”€â”€ github-repository-setup.sh
    â”œâ”€â”€ mcp-setup.sh
    â”œâ”€â”€ mcp-simple-setup.sh
    â”œâ”€â”€ project-updater.sh
    â””â”€â”€ wsl-quick-setup.sh
```

---

## ğŸš€ Getting Started

### Para DBAs

1. **Configurar credenciales:**
   ```bash
   export AZURE_SQL_SERVER="your-server.database.windows.net"
   export AZURE_SQL_DATABASE="your-database"
   ```

2. **Ejecutar anÃ¡lisis completo:**
   ```bash
   ./scripts/agents/sql-dba/sql-analyzer.sh \
     --server $AZURE_SQL_SERVER \
     --database $AZURE_SQL_DATABASE \
     --aad \
     --analysis all
   ```

3. **Detectar problemas:**
   ```bash
   # Transacciones zombie
   ./scripts/agents/sql-dba/detect-zombie-transactions.sh
   
   # O usar script interactivo en SSMS
   # docs/queries/zombie-diagnosis-interactive.sql
   ```

### Para Architects

1. **Desplegar Azure SQL con security baseline:**
   ```bash
   ./scripts/agents/architect/bicep-deploy.sh \
     --resource-group rg-prod \
     --template bicep/modules/sql-database.bicep \
     --parameters bicep/parameters/prod.json \
     --what-if
   ```

---

## ğŸ“š Documentation

### Nuevas GuÃ­as

- **ğŸ†• Diagnostic Checklists**: `docs/reference/diagnostic-checklists.md` (940+ lÃ­neas)
  - 5 checklists completos con criterios de decisiÃ³n
  - Lecciones de incidentes reales (caso 2025-12)
  - Ãrbol de decisiÃ³n para zombie transactions
  - Protocolos de validaciÃ³n pre/post diagnÃ³stico
- **SQL Connection Guide**: `docs/reference/azure-sql-connection-guide.md`
- **SQL Tools Reference**: `docs/reference/sql-tools-guide.md`
- **Zombie Transactions Quickstart**: `docs/reference/zombie-transactions-quickstart.md`
- **SQL Security Comparison**: `docs/reference/sql-solution-comparison.md`

### Scripts de Ejemplo

- **DiagnÃ³stico SSMS**: `docs/queries/zombie-diagnosis-interactive.sql`
- **DetecciÃ³n SQL**: `docs/queries/detect-zombie-transactions.sql`
- **AnÃ¡lisis de uso**: `docs/queries/analyze-usage-patterns.sql`

### Templates

- **Microsoft Support Email**: `docs/templates/email-brief.txt`
- **Email completo**: `docs/templates/microsoft-support-email-zombie-transactions.md`

---

## ğŸ“ Playbooks Incluidos

1. **Performance Degradation** - AnÃ¡lisis de CPU/IO/Memory
2. **Blocking & Deadlocks** - DetecciÃ³n y prevenciÃ³n
3. **Storage Growth (ADR/PVS)** - Troubleshooting especÃ­fico **+ ValidaciÃ³n diagnÃ³stica** ğŸ†•
4. **Architecture Design** - IaC con Bicep
5. **FinOps** - OptimizaciÃ³n de costos
6. **Security & Compliance** - Zero Trust patterns

---

## âš™ï¸ Technical Details

### Azure SQL DBA Agent Capabilities

- **Evidence-First Methodology**: No especulaciÃ³n, solo datos confirmados
- **ğŸ†• Diagnostic Validation Protocol**: Checklist obligatorio pre-diagnÃ³stico
- **ğŸ†• Learning from Incidents**: Lecciones documentadas de casos reales
- **ADR/PVS Awareness**: DetecciÃ³n avanzada de problemas storage
- **Approval Workflow**: Sistema de permisos para operaciones crÃ­ticas
- **Multi-Auth Support**: SQL auth + Azure AD authentication
- **Production Safety**: Blast radius analysis antes de cambios

### Tools Features

- **ğŸ†• pre-diagnosis-zombie-validation.sh**:
  - 5 checkpoints automÃ¡ticos
  - CorrelaciÃ³n temporal restart vs transactions
  - Session ownership detection (NULL = sistema)
  - PVS proportionality validation
  - Decision tree con interpretaciÃ³n

- **ğŸ†• post-diagnosis-validation.sh**:
  - Auto-validaciÃ³n de diagnÃ³stico dado
  - Checklist de evidencia recopilada
  - Red flags de diagnÃ³stico prematuro
  - Preguntas crÃ­ticas de sanity check

- **sql-query.py**:
  - Azure AD token encoding (struct.pack para >2000 chars)
  - SQL authentication
  - Output formats: table, json
  - Auto-instala pyodbc

- **sql-analyzer.sh**:
  - 8 anÃ¡lisis automatizados
  - slow-queries, missing-indexes, index-usage
  - table-sizes, blocking, fragmentation
  - statistics, Azure recommendations

- **detect-zombie-transactions.sh**:
  - DetecciÃ³n con colores
  - AnÃ¡lisis de impacto en espacio
  - Recomendaciones automÃ¡ticas

---

## ğŸ”„ Migration Guide

### Actualizar Referencias de Scripts

Si tienes scripts o documentaciÃ³n que referencian las rutas antiguas:

```bash
# Antiguo
./scripts/utils/sql-query.sh
./scripts/deploy/bicep-deploy.sh
./scripts/config/azure-config.sh

# Nuevo (desde v1.1.0)
./scripts/agents/sql-dba/sql-query.sh
./scripts/agents/architect/bicep-deploy.sh
./scripts/common/azure-config.sh
```

**Nota**: Si clonaste el repo despuÃ©s del 29/12/2025, ya tienes la nueva estructura.

---

## ğŸ› Known Issues

- **MCP SQL Server**: ConfiguraciÃ³n manual requerida en mcp.json
- **ODBC Driver 18**: Debe instalarse manualmente en Linux
- **Azure AD Tokens**: Requiere `az login` previo

---

## ğŸ“¦ Dependencies

### Nuevas Dependencias Opcionales

- **Python 3.8+**: Para sql-query.py
- **pyodbc**: Auto-instalado por scripts
- **ODBC Driver 18 for SQL Server**: Para conexiones SQL
- **Azure CLI**: Para Azure AD authentication

### InstalaciÃ³n RÃ¡pida

```bash
# Ubuntu/Debian
curl https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --dearmor -o /usr/share/keyrings/microsoft-prod.gpg
curl https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
sudo apt-get update
sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18
```

---

## ğŸ™ Contributors

- **alejandrolmeida** - 18 commits
  - Azure SQL DBA Agent development
  - SQL tools implementation
  - Documentation & guides
  - Infrastructure reorganization

---

## ğŸ“ Breaking Changes

### âš ï¸ IMPORTANTE: Cambios en Rutas de Scripts

La reorganizaciÃ³n de scripts es un **breaking change menor**. Si tienes:

- **Scripts personalizados** que llaman a scripts del repo
- **CI/CD pipelines** con rutas hardcodeadas
- **DocumentaciÃ³n externa** que referencia scripts

**Debes actualizar las rutas** segÃºn la tabla de migraciÃ³n arriba.

**Impacto**: Bajo (solo paths cambiaron, funcionalidad idÃ©ntica)

---

## ğŸ”— Links

- **Repository**: https://github.com/Alejandrolmeida/azure-agent-pro
- **v1.0.0 Release**: https://github.com/Alejandrolmeida/azure-agent-pro/releases/tag/v1.0.0
- **v1.1.0 Tag**: https://github.com/Alejandrolmeida/azure-agent-pro/releases/tag/v1.1.0
- **Issues**: https://github.com/Alejandrolmeida/azure-agent-pro/issues

---

## ğŸ¯ Next Steps (v1.2.0 Roadmap)

- [ ] Azure Container Apps agent
- [ ] Azure API Management agent
- [ ] Advanced networking patterns
- [ ] Multi-cloud integration (AWS/GCP)
- [ ] Industry-specific templates (Healthcare, Finance)

---

## ğŸ“„ License

MIT License - See LICENSE file for details

---

**Full Changelog**: https://github.com/Alejandrolmeida/azure-agent-pro/compare/v1.0.0...v1.1.0
